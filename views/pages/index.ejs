<!DOCTYPE html>
<html>
<% include ../partials/header.ejs %>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-108454703-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-108454703-1');
	</script>
	<title>Autohotran Beta!</title>
	<script type="text/javascript">
		(function($) {
			$(document).ready(function() {
				moment.tz.add("America/Fortaleza");
				var app = new Vue({
					el: "#hotran-app",
					data: {
						hotrans: [],
						hotranDetails: [{}],
						todayHotrans: [],
						views: {
							today: true,
							search: false,
						},		
						data: {
							companies: [],
							airports_origin: [],
							airports_destination: [],
							types: [],
							aircrafts: [],
						},
						hotran_details: [],
						hotran_company: '',
						hotran_airport_origin: '',
						hotran_airport_destination: '',						
						hotran_type: '',
						hotran_aircraft: '',
						hotran_date: '',
					},
					methods: {
						getFormattedDate(string) {
							var date = moment(string, 'YYYY-MM-DD').format('DD/MM/YYYY');
							return date;
						},
						toggleModal: function(hotran) {							
							var params = {
								cod_empresa: hotran.cod_empresa,
								cod_hotran: hotran.cod_hotran,
								voo: hotran.voo,
								data_solicitacao: moment(hotran.data_solicitacao, 'YYYY-MM-DD').format('YYYY-MM-DD')
							};
							this.$http.get('/hotran/merge', {params: params}).then(response => {
								var voos = response.body;								
								this.hotranDetails = voos;
								for( var i in this.hotranDetails ) 
								{
									var days = [];									 		
									for( var d in this.hotranDetails[i].dias ) 
									{
										if( this.hotranDetails[i].dias[d] )
										{
											switch(d)
											{															
												case 'domingo': days.push('dom'); break;
												case 'sabado': days.push('sab'); break;
												case 'sexta_feira': days.push('6ª'); break;
												case 'quinta_feira': days.push('5ª'); break;
												case 'quarta_feira': days.push('4ª'); break;
												case 'terca_feira': days.push('3ª'); break;
												case 'segunda_feira': days.push('2ª'); break;
											}
										}
									}
									
									this.hotranDetails[i]['daysDetails'] = days.reverse().join(", ");	
								}
								
								$("#hotran-details-modal").modal('show');
							});							
						},
						toggleView: function(key) {
							this.views[key] = true;
							Object.keys(this.views).forEach(vk => {
								if(key != vk) this.views[vk] = false;
							});							
						},
						search: function() {							
							this.$http.get('/hotran/api', {params: {
								nome_empresa: this.hotran_company,
								aeroporto_origem: this.hotran_airport_origin,
								aeroporto_destino: this.hotran_airport_destination,
								tipo: this.hotran_type,
								aeronave: this.hotran_aircraft,
								data_solicitacao: this.hotran_date,
							}}).then(response => {
								this.hotrans = response.body;								
								$("#hotran-search-modal").modal('hide');

								if(!this.hotrans.length) alert("Sem hotrans para esta busca!");
								else this.toggleView('search');								
							});							
						},
						loadFields: function() {
							this.$http.get('/hotran/fields', {params: {field: 'nome_empresa'}}).then(response => {
								this.data.companies = response.body;								
							});
							this.$http.get('/hotran/fields', {params: {field: 'aeroporto_origem'}}).then(response => {
								this.data.airports_origin = response.body;								
							});
							this.$http.get('/hotran/fields', {params: {field: 'aeroporto_destino'}}).then(response => {
								this.data.airports_destination = response.body;								
							});
							this.$http.get('/hotran/fields', {params: {field: 'tipo'}}).then(response => {
								this.data.types = response.body;								
							});
							this.$http.get('/hotran/fields', {params: {field: 'aeronave'}}).then(response => {
								this.data.aircrafts = response.body;
							});
						}
					},
					mounted: function() {
						var today = "<%= today %>";
						this.loadFields();
						this.$http.get('/hotran/api', {params: {data_solicitacao: today}}).then(response => {
							this.todayHotrans = response.body;							
						});
						$('#hotran-date-input').datepicker({
							autoclose: true,
							disableTouchKeyboard: true,
							format: 'dd-mm-yyyy',
							language: "pt-BR",
							todayHighlight: true,
						}).on("changeDate", () => {
							this.hotran_date = $("#hotran-date-input").val();
						});
					}
				}); // hotran-app				
});
})(jQuery)
</script>		
</head>
<body>	
	<div id="hotran-app">
		<div class="modal fade" v-model="hotran_details" id="hotran-details-modal">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Detalhes do hotran – {{ hotranDetails[0].cod_hotran }}</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">						
						<p>Malha {{ hotranDetails[0].nome_empresa }} ({{ hotranDetails[0].cod_empresa }})</p>
						<p><b>Solicitação {{ getFormattedDate(hotranDetails[0].data_solicitacao) }} – {{ hotranDetails[0].tipo }} – a Distribuir – Efetivo {{ getFormattedDate(hotranDetails[0].data_vigencia) }}.</b></p>
						
						<div v-for="flight in hotranDetails">{{ flight.cod_empresa }}{{ flight.voo }} – {{ flight.daysDetails }} – {{ flight.cod_origem }} {{ flight.horario_partida }} {{ flight.cod_destino }} {{ flight.horario_chegada }} – {{ flight.aeronave }} ({{ flight.assentos }} pax)						
						</div>
						<br/>
						
						<p><b>Hotran {{ hotranDetails[0].cod_hotran }} ({{ hotranDetails[0].natureza }})</b></p>	
					</div>
					<div class="modal-footer">
						<btn class="btn btn-primary" data-dismiss="modal">Fechar <i class="fa fa-remove"></i></btn>
					</div>
				</div>
			</div>
		</div><!-- modal -->
		<nav class="navbar navbar-toggleable-md navbar-light bg-faded">
			<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navmenu" aria-controls="navmenu" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<a class="navbar-brand" href="#" v-on:click="toggleView('today')"><span class="site-title">Autohotran</span> <span class="beta">beta!</span></a>
			<div class="collapse navbar-collapse" id="navmenu">
				<ul class="navbar-nav ml-auto"> <!-- Menu -->					
					<li class="nav-item"><a class="nav-link" href="#" v-on:click="toggleView('today')">Hotrans de Hoje</a></li>
					<li class="nav-item">
						<a class="nav-link dropdown-toggle" href="#" data-toggle="modal" data-target="#hotran-search-modal" id="hotran-search-toggler">Pesquisar Hotran</a>
						<div class="modal fade" id="hotran-search-modal"> <!-- modal -->
							<div class="modal-dialog" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title">Pesquisa de Hotran <i class="fa fa-plane"></i></h5>
										<button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body">
										<p class="hotran-search-warning">** Ao deixar algum dos campos abaixo vazio, seu valor será indiferente na busca.</p>
										<div class="form-group">
											<label for="hotran_company">Companhia aérea</label>
											<select class="form-control" v-model="hotran_company">
												<option selected></option>
												<option v-for="company in data.companies">{{ company }}</option>
											</select>
										</div>
										<div class="form-group">
											<label for="hotran_origin">Aeroporto Origem</label>
											<select class="form-control" v-model="hotran_airport_origin">
												<option selected></option>
												<option v-for="airport in data.airports_origin">{{ airport }}</option>
											</select>
										</div>
										<div class="form-group">
											<label for="hotran_destination">Aeroporto Destino</label>
											<select class="form-control" v-model="hotran_airport_destination">
												<option selected></option>
												<option v-for="airport in data.airports_destination">{{ airport }}</option>
											</select>
										</div>										
										<div class="form-group">
											<label for="hotran_type">Tipo de hotran</label>
											<select class="form-control" v-model="hotran_type">
												<option selected></option>
												<option v-for="type in data.types">{{ type }}</option>
											</select>
										</div>
										<div class="form-group">
											<label for="hotran_aircraft">Aeronave</label>
											<select class="form-control" v-model="hotran_aircraft">
												<option selected></option>
												<option v-for="aircraft in data.aircrafts">{{ aircraft }}</option>
											</select>
										</div>
										<div class="form-group">
											<label for="hotran_date">Data</label>
											<input type="text" id="hotran-date-input" class="form-control" v-model="hotran_date" readonly>
										</div>
									</div>
									<div class="modal-footer">
										<button type="button" v-on:click="search" class="btn hotran-btn-submit">Buscar</button>
									</div>
								</div>
							</div>
						</div> <!-- modal -->					
					</li>
					<li class="nav-item"><a class="nav-link hotran-update" href="#">Última atualização: <%= lastUpdate.message %></a></li>
				</ul>
			</div>
		</nav>
		<div class="hotran-container">
			<div class="container-fluid">
				<p class="about">** Este site é responsável por reunir as solicitações de HOTRAN (horário de transporte) das companhias aéreas brasileiras, a fim de informar os usuários de novos voos solicitados diariamente e em datas específicas.</p>
				<p class="today-hotrans" v-if="views.today">
					<span v-if="!todayHotrans.length">Sem novas solicitações de HOTRAN para hoje.</span>
					<span v-else>Exibindo {{ todayHotrans.length }} solicitações de HOTRAN de hoje.</span>
				</p>
				<p class="search-hotrans" v-if="views.search">Exibindo {{ hotrans.length }} solicitações de HOTRAN de acordo com sua pesquisa.</p>
				<div class="hotran-list">
					<table class="table table-bordered table-responsive">
						<thead>
							<tr>
								<td class="text-center">Companhia</td>
								<td class="text-center">Hotran</td>
								<td class="text-center">Aeronave</td>
								<td class="text-center">Voo</td>								
								<td class="text-center">Origem <i class="fa fa-plane" aria-hidden="true"></i></td>
								<td class="text-center">Destino <i class="fa fa-plane" aria-hidden="true"></i></td>
								<td class="text-center">Data Solicitação</td>
								<td class="text-center">Tipo</td>
								<td class="text-center"><b>Visualizar HOTRAN</b></td>								
							</tr>
						</thead>
						<tbody v-if="views.today"> <!-- today view -->
							<tr v-for="hotran in todayHotrans">
								<td class="text-center">{{ hotran.nome_empresa }}</td>
								<td class="text-center">{{ hotran.cod_hotran }}</td>
								<td class="text-center">{{ hotran.aeronave }} <p>({{ hotran.assentos }} pax)</p></td>
								<td class="text-center">{{ hotran.cod_empresa + hotran.voo }}</td>
								<td class="text-center">
									{{ hotran.aeroporto_origem.substr(0, 25).concat(' ...') }} (<b>{{ hotran.cod_origem }}</b>)
								</td>
								<td class="text-center">
									{{ hotran.aeroporto_destino.substr(0, 25).concat(' ...') }} (<b>{{ hotran.cod_destino }}</b>)
								</td>
								<td class="text-center">{{ getFormattedDate(hotran.data_solicitacao) }}</td>
								<td class="text-center">{{ hotran.tipo }}</td>
								<td class="text-center">
									<a v-on:click="toggleModal(hotran)">
										<button type="button" class="btn btn-outline-info btn-hotran-info">
											<i class="fa fa-table" aria-hidden="true"></i>
										</button>
									</a>
								</td>								
							</tr>						
						</tbody>
						<tbody v-if="views.search"> <!-- search view -->
							<tr v-for="hotran in hotrans">
								<td class="text-center">{{ hotran.nome_empresa }}</td>
								<td class="text-center">{{ hotran.cod_hotran }}</td>
								<td class="text-center">{{ hotran.aeronave }} <p>({{ hotran.assentos }} pax)</p></td>
								<td class="text-center">{{ hotran.cod_empresa + hotran.voo }}</td>
								<td class="text-center">
									{{ hotran.aeroporto_origem.substr(0, 25).concat(' ...') }} (<b>{{ hotran.cod_origem }}</b>)
								</td>
								<td class="text-center">
									{{ hotran.aeroporto_destino.substr(0, 25).concat(' ...') }} (<b>{{ hotran.cod_destino }}</b>)
								</td>
								<td class="text-center">{{ getFormattedDate(hotran.data_solicitacao) }}</td>
								<td class="text-center">{{ hotran.tipo }}</td>
								<td class="text-center">
									<a v-on:click="toggleModal(hotran)">
										<button type="button" class="btn btn-outline-info btn-hotran-info">
											<i class="fa fa-table" aria-hidden="true"></i>
										</button>
									</a>
								</td>
							</tr>						
						</tbody>  
					</table>
				</div>				
			</div>
		</div>		
	</div> <!-- #hotran-app -->
	<footer class="navbar footer">Copyright © <%= moment().tz('America/Fortaleza').format('YYYY') %> - Felzend Network Inc.</footer>
</body>
</html>
